#
# Test of the MyISAM key cache
#
--disable_warnings
drop table if exists t1, t2, t3;
--enable_warnings

SET @save_myisam_key_cache_size=@@myisam_key_cache_size;
SET @save_myisam_key_cache_block_size=@@myisam_key_cache_block_size;
SET @save_myisam_key_cache_division_limit=@@myisam_key_cache_division_limit;
SET @save_myisam_key_cache_age_threshold=@@myisam_key_cache_age_threshold;

# Show default variables for MyISAM key cache
SELECT @@myisam_key_cache_size;
SELECT @@myisam_key_cache_block_size;
SELECT @@myisam_key_cache_division_limit;
SELECT @@myisam_key_cache_age_threshold;

# Change default key cache size
SET @@global.myisam_key_cache_size=16*1024*1024;

# Drop Key Cache (warning generated)
SET @@global.myisam_key_cache_size=0;
# Test double drop
SET @@global.myisam_key_cache_size=0;

# Change default key cache size
SET @@global.myisam_key_cache_size=16*1024*1024;

# Print key buffer with different syntaxes
SHOW VARIABLES like "myisam_key_cache_size";
SELECT @@myisam_key_cache_size;
SELECT @@global.myisam_key_cache_size;
SELECT @@global.myisam_key_cache_size;
SELECT @@global.`myisam_key_cache_size`;
SELECT @@global.`myisam_key_cache_size`;
SELECT @@myisam_key_cache_size;

SET @@global.myisam_key_cache_size=@save_myisam_key_cache_size;

#
# Errors
#

SELECT @@myisam_key_cache_size;
-- error 1272
SELECT @@skr.storage_engine="test";

-- error 1272
select @@keycache1.myisam_key_cache_block_size;

show status like 'key_blocks_used';

# Test to set up a too small size for a key cache (bug #2064)
set global myisam_key_cache_size=100;

#
# Bug #19079: corrupted index when myisam_key_cache_block_size is not multiple of
#             myisam_block_size

CREATE temporary TABLE t1(a int NOT NULL AUTO_INCREMENT PRIMARY KEY) ENGINE=MYISAM;
SET GLOBAL myisam_key_cache_block_size=1536;
INSERT INTO t1 VALUES (1);
SELECT @@myisam_key_cache_block_size;
CHECK TABLE t1;
DROP TABLE t1;

CREATE TEMPORARY TABLE t1(a int NOT NULL AUTO_INCREMENT PRIMARY KEY, b int) ENGINE=MYISAM;
CREATE TEMPORARY TABLE t2(a int NOT NULL AUTO_INCREMENT PRIMARY KEY, b int) ENGINE=MYISAM;
SET GLOBAL myisam_key_cache_block_size=1536;
INSERT INTO t1 VALUES (1,0);
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
INSERT INTO t2(b) SELECT b FROM t1;
INSERT INTO t1(b) SELECT b FROM t2;
SELECT COUNT(*) FROM t1;
SELECT @@myisam_key_cache_block_size;
CHECK TABLE t1;
DROP TABLE t1,t2;
# Restore changed variables
set global myisam_key_cache_block_size= @save_myisam_key_cache_block_size;

#
# Bug#28478 - Improper myisam_key_cache_block_size corrupts MyISAM tables
#
SET GLOBAL myisam_key_cache_block_size= 1536;
CREATE TEMPORARY TABLE t1 (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  c1 CHAR(50),
  c2 CHAR(50),
  c3 CHAR(50),
  KEY(c1, c2, c3)
  ) ENGINE= MyISAM;
INSERT INTO t1 (c1, c2, c3) VALUES
  ('a', 'b', 'c'), ('b', 'c', 'd'), ('c', 'd', 'e'), ('d', 'e', 'f'),
  ('e', 'f', 'g'), ('f', 'g', 'h'), ('g', 'h', 'i'), ('h', 'i', 'j'),
  ('i', 'j', 'k'), ('j', 'k', 'l'), ('k', 'l', 'm'), ('l', 'm', 'n'),
  ('m', 'n', 'o'), ('n', 'o', 'p'), ('o', 'p', 'q'), ('p', 'q', 'r'),
  ('q', 'r', 's'), ('r', 's', 't'), ('s', 't', 'u'), ('t', 'u', 'v'),
  ('u', 'v', 'w'), ('v', 'w', 'x'), ('w', 'x', 'y'), ('x', 'y', 'z');
CREATE TABLE t2 AS SELECT * FROM t1;
INSERT INTO t1 (c1, c2, c3) SELECT c1, c2, c3 from t2;
INSERT INTO t1 (c1, c2, c3) SELECT c1, c2, c3 from t2;
INSERT INTO t1 (c1, c2, c3) SELECT c1, c2, c3 from t2;
CHECK TABLE t1;
SHOW VARIABLES LIKE 'myisam_key_cache_block_size';
SET GLOBAL myisam_key_cache_block_size= @save_myisam_key_cache_block_size;
DROP TABLE t1,t2;

# Check division limit and age threshold

# Division Limit: Minimum 1, maximum 100
SET GLOBAL myisam_key_cache_division_limit= 0;

SELECT @@myisam_key_cache_division_limit;

SET GLOBAL myisam_key_cache_division_limit= 101;

SELECT @@myisam_key_cache_division_limit;

# Age Threshold: Minimum 100, maximum UINT32_MAX
SET GLOBAL myisam_key_cache_age_threshold= 98;

SELECT @@myisam_key_cache_age_threshold;

SET GLOBAL myisam_key_cache_age_threshold= 5000000000;

SELECT @@myisam_key_cache_age_threshold;
