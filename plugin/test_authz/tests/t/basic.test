# Check for error if no parameter provided
create database authz_no;
--error ER_NO_SUCH_TABLE
SELECT * from authz_no.dont_exist;
create database authz_yes;
show databases;
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
connect (should_succeed,localhost,authz,test,,);
connection should_succeed;
show databases;
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
--replace_regex /@'.*?'/@'LOCALHOST'/
--error ER_DBACCESS_DENIED_ERROR
SELECT * from authz_no.dont_exist;
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
--replace_regex /@'.*?'/@'LOCALHOST'/
--error ER_DBACCESS_DENIED_ERROR
create database authz_no;
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
--replace_regex /@'.*?'/@'LOCALHOST'/
--error ER_DBACCESS_DENIED_ERROR
drop database authz_no;

--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
connect (con1,localhost,root,test,,);
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
connect (con2,localhost,root,test,,);
connection con1;

--replace_column 3 # 5 # 6 # 7 #
show processlist;

--disable_reconnect
create table t1 (kill_id int);
insert into t1 values(connection_id());

connection con2;
select ((@id := kill_id) - kill_id) from t1;
kill @id;

connection con1;
--sleep 2

--disable_query_log
--disable_result_log
# One of the following statements should fail
--error 0,5,20,23
select 1;
--error 0,5,20,23
select 1;
--enable_query_log
--enable_result_log
--enable_reconnect

select ((@id := kill_id) - kill_id) from t1;
select @id != connection_id();

update t1 set kill_id= connection_id();

connection should_succeed;
--replace_column 3 # 6 #
show processlist;
select ((@id := kill_id) - kill_id) from t1;

--error ER_NO_SUCH_THREAD
kill @id;




# Test failing initial connection
--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
--replace_regex /@'.*?'/@'LOCALHOST'/
--error ER_DBACCESS_DENIED_ERROR
connect (should_fail,localhost,authz,,authz_no,,);

connection default;
drop table t1;
drop schema authz_yes;
drop schema authz_no;
