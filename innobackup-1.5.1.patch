--- innobackup-1.5.1_orig	2009-03-04 21:41:35.000000000 +0900
+++ innobackup-1.5.1	2009-03-10 16:45:21.000000000 +0900
@@ -8,6 +8,7 @@
 
 use strict;
 use Getopt::Long;
+use File::Spec;
 use POSIX "strftime";
 use POSIX ":sys_wait_h";
 use POSIX "tmpnam";
@@ -15,7 +16,7 @@
 
 
 # version of this script
-my $innobackup_version = '1.5.1';
+my $innobackup_version = '1.5.1-xtrabackup';
 
 # copyright notice
 my $copyright_notice = 
@@ -64,6 +65,7 @@
 my $option_copy_back = '';
 my $option_include = '';
 my $option_databases = '';
+my $option_throttle = '';
 my $option_sleep = '';
 my $option_compress = 999;
 my $option_uncompress = '';
@@ -74,10 +76,13 @@
 my $option_mysql_socket = '';
 my $option_no_timestamp = '';
 my $option_slave_info = '';
-my $option_ibbackup_binary = 'ibbackup';
+my $option_ibbackup_binary = 'xtrabackup';
+
+my $option_incremental = '';
+my $option_remote_host = '';
 
 # name of the my.cnf configuration file
-my $config_file = '';
+#my $config_file = '';
 
 # root of the backup directory
 my $backup_root = '';
@@ -98,7 +103,7 @@
 my %config;
 
 # options from the backup options file
-my %backup_config;
+#my %backup_config;
 
 # list of databases to be included in a backup
 my %databases_list;
@@ -212,10 +217,10 @@
 innobackup [--sleep=MS] [--compress[=LEVEL]] [--include=REGEXP] [--user=NAME] 
            [--password=WORD] [--port=PORT] [--socket=SOCKET] [--no-timestamp] 
            [--ibbackup=IBBACKUP-BINARY] [--slave-info]
-           [--databases=LIST] MY.CNF BACKUP-ROOT-DIR
+           [--databases=LIST] BACKUP-ROOT-DIR
 innobackup --apply-log [--use-memory=MB] [--uncompress] 
-           [--ibbackup=IBBACKUP-BINARY] MY.CNF BACKUP-DIR
-innobackup --copy-back MY.CNF BACKUP-DIR
+           [--ibbackup=IBBACKUP-BINARY] BACKUP-DIR
+innobackup --copy-back BACKUP-DIR
 
 The first command line above makes a hot backup of a MySQL database.
 By default it creates a backup directory (named by the current date
@@ -267,12 +272,18 @@
                 memory in restoration.
                 Try 'ibbackup --help' for more details on this option.
 
+    --throttle=IOS
+                This option is passed to the xtrabackup child process.
+                It limits count of IO operations (pairs of read&write) per
+                second to IOS values (for '--backup')
+
     --sleep=MS  This option is passed to the ibbackup child process.
                 It instructs the ibbackup program to sleep 
                 MS milliseconds after each 1 MB of copied data.
                 You can use this parameter to tune the additional 
                 disk i/o load the ibbackup program causes on the computer.
                 Try 'ibbackup --help' for more details on this option.
+                ** it is not supported by xtrabackup **
 
     --compress[=LEVEL]
                 This option is passed to the ibbackup child process.
@@ -283,6 +294,7 @@
                 9 gives best compression, and 0 means no compression. 
                 If compression level is not given, the default level 1 is used.
                 Try 'ibbackup --help' for more details on this option.
+                ** it is not supported by xtrabackup yet **
 
     --include=REGEXP 
                 This option is passed to the ibbackup child process.
@@ -295,6 +307,7 @@
                 included in the backup. The regular expression should
                 be of the POSIX 1003.2 "extended" form.  
                 Try 'ibbackup --help' for more details on this option.
+                ** it is not supported by xtrabackup yet **
 
     --databases=LIST
                 This option is used to specify the list of databases that
@@ -312,6 +325,7 @@
                 This option is passed to the ibbackup child process.
                 It tells ibbackup to uncompress compressed InnoDB data files.
                 Try 'ibbackup --help' for more details on this option.
+                ** it is not supported by xtrabackup yet **
                 
     --user=NAME This option is passed to the mysql child process.
                 It defines the user for database login if not current user.
@@ -408,7 +422,9 @@
     start_ibbackup();
 
     # wait for ibbackup to suspend itself
-    wait_for_ibbackup_suspend();
+    if (!$option_incremental) {
+        wait_for_ibbackup_suspend();
+    }
 
     # connect to database
     mysql_open();
@@ -504,7 +520,7 @@
     my $orig_iblog_dir =
         get_option(\%config, 'mysqld', 'innodb_log_group_home_dir');
     my $excluded_files = 
-        '^(\.\.?|backup-my\.cnf|ibbackup_logfile|mysql-std(err|out)|.*\.ibz)$';
+        '^(\.\.?|backup-my\.cnf|xtrabackup_logfile|mysql-std(err|out)|.*\.ibz)$';
     my @ibdata_files;
     my $iblog_files = '^ib_logfile.*$';
     my $compressed_data_file = '.*\.ibz$';
@@ -526,17 +542,17 @@
 
     # check that the original options file and the backup options file have
     # the same value for "innodb_data_file_path" option
-    $backup_innodb_data_file_path = 
-        get_option(\%backup_config, 'mysqld', 'innodb_data_file_path');
-    if (!are_equal_innodb_data_file_paths($orig_innodb_data_file_path, 
-                                          $backup_innodb_data_file_path)
-    ) {
-        Die "The value of 'innodb_data_file_path' option in the original "
-          . "my.cnf file '$config_file' is different from the value "
-          . "in the backup my.cnf file '$backup_config_file'.\n(original: "
-          . "'$orig_innodb_data_file_path')\n"
-          . "(backup:   '$backup_innodb_data_file_path')";
-    }
+    #$backup_innodb_data_file_path = 
+    #    get_option(\%backup_config, 'mysqld', 'innodb_data_file_path');
+    #if (!are_equal_innodb_data_file_paths($orig_innodb_data_file_path, 
+    #                                      $backup_innodb_data_file_path)
+    #) {
+    #    Die "The value of 'innodb_data_file_path' option in the original "
+    #      . "my.cnf file '$config_file' is different from the value "
+    #      . "in the backup my.cnf file '$backup_config_file'.\n(original: "
+    #      . "'$orig_innodb_data_file_path')\n"
+    #      . "(backup:   '$backup_innodb_data_file_path')";
+    #}
 
     # make a list of all ibdata files in the backup directory and all
     # directories in the backup directory under which there are ibdata files
@@ -640,17 +656,19 @@
 sub apply_log {
     my $rcode;
     my $cmdline = '';
-    my $options = '--restore';
+    my $options = '--prepare';
+
+    $options = $options . " --target-dir=$backup_dir";
 
     if ($option_uncompress) {
         $options = $options . ' --uncompress';
     }
     if ($option_use_memory) {
-        $options = $options . " --use-memory $option_use_memory";
+        $options = $options . " --use-memory=$option_use_memory";
     }
 
     # run ibbackup as a child process
-    $cmdline = "$option_ibbackup_binary $options $backup_dir/backup-my.cnf";
+    $cmdline = "$option_ibbackup_binary $options";
     $now = current_time();
     print "\n$now  $prefix Starting ibbackup with command: $cmdline\n\n";
     $rcode = system("$cmdline");
@@ -658,6 +676,14 @@
         # failure
         Die "\n$prefix ibbackup failed";
     }
+
+    $now = current_time();
+    print "\n$now  $prefix Restarting xtrabackup with command: $cmdline\nfor creating ib_logfile*\n\n";
+    $rcode = system("$cmdline");
+    if ($rcode) {
+        # failure
+        Die "\n$prefix xtrabackup (2nd execution) failed";
+    }
 }
 
 
@@ -702,25 +728,32 @@
 # program for backing up InnoDB tables and indexes.
 #
 sub start_ibbackup {
-    my $options = '--suspend-at-end';
+    my $options = '--backup --suspend-at-end';
     my $cmdline = '';
     my $pid = undef;
 
+    $options = $options . " --target-dir=$backup_dir";
+
     # prepare command line for running ibbackup
+    if ($option_throttle) {
+        $options = $options . " --throttle=$option_throttle";
+    }
     if ($option_sleep) {
-        $options = $options . " --sleep $option_sleep";
+        $options = $options . " --sleep=$option_sleep";
     }
     if ($option_compress) {
-        $options = $options . " --compress $option_compress";
+        $options = $options . " --compress=$option_compress";
     }
     if ($option_use_memory) {
-        $options = $options . " --use-memory $option_use_memory";
+        $options = $options . " --use-memory=$option_use_memory";
     }
     if ($option_include) {
-        $options = $options . " --include '$option_include'";
+        $options = $options . " --include='$option_include'";
+    }
+    if ($option_incremental) {
+        $options = $options . " --log-stream";
     }
-    $cmdline = "$option_ibbackup_binary $options $config_file "
-        ."$backup_config_file";
+    $cmdline = "$option_ibbackup_binary $options";
 
     # run ibbackup as a child process
     $now = current_time();
@@ -729,7 +762,71 @@
         if ($pid) {
             # parent process
             $ibbackup_pid = $pid;
+
+            if($option_incremental) {
+                #incremental mode
+                my $orig_datadir = get_option(\%config, 'mysqld', 'datadir');
+                my $orig_ibdata_dir =
+                    get_option(\%config, 'mysqld', 'innodb_data_home_dir');
+                my $orig_innodb_data_file_path =
+                    get_option(\%config, 'mysqld', 'innodb_data_file_path');
+                my $subdir;
+                my @list;
+
+                if (-e "$backup_dir/ib_logfile0") {
+                    print "$prefix Remove $backup_dir/ib_logfile*\n";
+                    system("rm $backup_dir/ib_logfile*");
+                }
+
+                wait_for_ibbackup_suspend();
+
+                #InnoDB data files from original InnoDB data directory
+                print "\n$prefix Starting to rsync InnoDB tables and indexes\n";
+                print "$prefix to '$backup_dir'\n";
+                print "$prefix from original InnoDB data directory '$orig_ibdata_dir'\n";
+                foreach my $a (split(/;/, $orig_innodb_data_file_path)) {
+                    my $path = (split(/:/,$a))[0];
+                    print "$prefix Copying file '$orig_ibdata_dir/$path'\n";
+                    system("rsync -a '$orig_ibdata_dir/$path' '$backup_dir/$path'")
+                        and Die "Failed to rsync file '$path': $!";
+                }
+
+                #copy *.ibd files
+                opendir(DIR, $orig_datadir)
+                    || Die "Can't open directory '$orig_datadir': $!\n";
+                while (defined($subdir = readdir(DIR))) {
+                    my $print_each_file = 0;
+                    my $file_c;
+                    my $file;
+                    if ($subdir eq '.' || $subdir eq '..') { next; }
+                    next unless -d "$orig_datadir/$subdir";
+                    next unless check_if_required($subdir);
+
+                    @list = glob("$orig_datadir/$subdir/" . '*.ibd');
+
+                    $file_c = @list;
+                    if ($file_c <= $backup_file_print_limit) {
+                        $print_each_file = 1;
+                    } else {
+                        print "$prefix Backing up files " .
+                            "'$orig_datadir/$subdir/*.ibd' ($file_c files)\n";
+                    }
+                    foreach $file (@list) {
+                        if ($print_each_file) {
+                            print "$prefix Backing up file '$file'\n";
+                        }
+                        system("rsync -a '$file' '$backup_dir/$subdir/'")
+                            and Die "Failed to rsync file '$file': $!";
+                    }
+                }
+                closedir(DIR);
+            }
         } else {
+            if($option_incremental) {
+                open(STDOUT, "> $backup_dir/xtrabackup_logfile")
+                    || Die "Failed to open file '$backup_dir/xtrabackup_logfile': $!"
+            }
+
             # child process
             exec($cmdline) || Die "Failed to exec ibbackup: $!";
         }
@@ -1174,8 +1271,8 @@
             $mysql_server_version = $lines[1];
             print "$prefix Using mysql server version $mysql_server_version\n";
         }
-        require_external($option_ibbackup_binary, '--license', 
-                         'version (\S+)', \$ibbackup_version);
+        #require_external($option_ibbackup_binary, '--license', 
+        #                 'version (\S+)', \$ibbackup_version);
         print "\n";
         
         if ($option_include 
@@ -1193,26 +1290,45 @@
     $SIG{PIPE} = \&catch_sigpipe;
 
     # read MySQL options file
-    read_config_file($config_file, \%config);
+    #read_config_file($config_file, \%config);
+    read_config_file(\%config);
 
     # get innodb log home directory from options file
-    $innodb_log_group_home_dir = 
-        get_option(\%config, 'mysqld', 'innodb_log_group_home_dir');
+    #$innodb_log_group_home_dir = 
+    #    get_option(\%config, 'mysqld', 'innodb_log_group_home_dir');
 
     if (!$option_apply_log && !$option_copy_back) {
         # we are making a backup, create a new backup directory
-        $backup_dir = make_backup_dir();
+        if (!$option_incremental) {
+            $backup_dir = File::Spec->rel2abs(make_backup_dir());
+        } else {
+            #incremental mode
+            my $innodb_data_file_path =
+                get_option(\%config, 'mysqld', 'innodb_data_file_path');
+
+            $backup_dir = File::Spec->rel2abs($backup_root);
+
+            # create subdirectories for ibdata files if needed
+            foreach my $a (split(/;/, $innodb_data_file_path)) {
+                my $path = (split(/:/,$a))[0];
+                my @relative_path = split(/\/+/, $path);
+                pop @relative_path;
+                if (@relative_path) {
+                    create_path_if_needed($backup_dir, \@relative_path);
+                }
+            }
+        }
         print "$prefix Created backup directory $backup_dir\n";
         $backup_config_file = $backup_dir . '/backup-my.cnf';
         write_backup_config_file($backup_config_file);
-        $suspend_file = $backup_dir . '/ibbackup_suspended';
+        $suspend_file = $backup_dir . '/xtrabackup_suspended';
         $mysql_stdout = $backup_dir . '/mysql-stdout';
         $mysql_stderr = $backup_dir . '/mysql-stderr';
-        $binlog_info = $backup_dir . '/ibbackup_binlog_info';
-        $slave_info = $backup_dir . '/ibbackup_slave_info';
+        $binlog_info = $backup_dir . '/xtrabackup_binlog_info';
+        $slave_info = $backup_dir . '/xtrabackup_slave_info';
     } elsif ($option_copy_back) {
-        $backup_config_file = $backup_dir . '/backup-my.cnf';
-        read_config_file($backup_config_file, \%backup_config);
+        #$backup_config_file = $backup_dir . '/backup-my.cnf';
+        #read_config_file($backup_config_file, \%backup_config);
     }         
 }
 
@@ -1290,12 +1406,13 @@
     $rcode = GetOptions('compress:i' => \$option_compress,
                         'help' => \$option_help,
                         'version' => \$option_version,
+                        'throttle=i' => \$option_throttle,
                         'sleep=i' => \$option_sleep,
                         'apply-log' => \$option_apply_log,
                         'copy-back' => \$option_copy_back,
                         'include=s' => \$option_include,
 			'databases=s' => \$option_databases,
-                        'use-memory=i' => \$option_use_memory,
+                        'use-memory=s' => \$option_use_memory,
                         'uncompress' => \$option_uncompress,
                         'password=s' => \$option_mysql_password,
                         'user=s' => \$option_mysql_user,
@@ -1303,6 +1420,8 @@
                         'slave-info' => \$option_slave_info,
                         'socket=s' => \$option_mysql_socket,
                         'no-timestamp' => \$option_no_timestamp,
+                        'incremental' => \$option_incremental,
+                        'remote-host=s' => \$option_remote_host,
                         'ibbackup=s' => \$option_ibbackup_binary);
     if (!$rcode) {
         # failed to read options
@@ -1331,25 +1450,29 @@
 	$option_compress = 0;
     }
 
-    if (@ARGV < 2) {
+    if (@ARGV < 1) {
         print "$prefix Missing command line argument\n";
         usage();
         exit(1);
-    } elsif (@ARGV > 2) {
+    } elsif (@ARGV > 1) {
         print "$prefix Too many command line arguments\n";
         usage();
         exit(1);
     }
 
     # get options file name
-    $config_file = $ARGV[0];
+    #$config_file = $ARGV[0];
 
     if (!$option_apply_log && !$option_copy_back) {
         # we are making a backup, get backup root directory
-        $backup_root = $ARGV[1];
+        $backup_root = $ARGV[0];
+        if ($option_remote_host && !$option_incremental) {
+            print "Remote backup supports incremental(rsync) mode only for now.\n";
+            exit(1);
+        }
     } else {
         # get backup directory
-        $backup_dir = $ARGV[1];
+        $backup_dir = File::Spec->rel2abs($ARGV[0]);
     }        
 
     print "\n";
@@ -1488,8 +1611,13 @@
             if ($print_each_file) {
                 print "$prefix Backing up file '$file'\n";
             }
+            if (!$option_incremental) {
             system("cp -p '$file' '$backup_dir/$database'")
                 and Die "Failed to copy file '$file': $!";
+            } else {
+            system("rsync -a '$file' '$backup_dir/$database'")
+                and Die "Failed to rsync file '$file': $!";
+            }
         }
     }
     closedir(DIR);
@@ -1576,15 +1704,20 @@
 #                   options are returned
 #
 sub read_config_file {
-    my $filename = shift;
+    #my $filename = shift;
     my $groups_ref = shift;
     my @lines ;
     my $i;
     my $group;
     my $group_hash_ref;
 
+    my $cmdline = '';
+    my $options = '--print-param';
+
     # read file to an array, one line per element
-    file_to_array($filename, \@lines);
+    #file_to_array($filename, \@lines);
+    $cmdline = "$option_ibbackup_binary $options";
+    @lines = `$cmdline`;
 
     # classify lines and save option values
     $group = 'default';
@@ -1637,7 +1770,7 @@
           # unknown
           print("$prefix: Warning: Ignored unrecognized line ",
                 $i + 1,
-                " in options file '$filename': '${lines[$i]}'\n"
+                " in options : '${lines[$i]}'\n"
                 );
       }
    }
@@ -1662,14 +1795,14 @@
 
     if (!exists $config{$group}) {
         # no group
-        print "$prefix fatal error: no '$group' group in MySQL options file '$config_file\n";
+        print "$prefix fatal error: no '$group' group in MySQL options\n";
         exit(1);
     }
     
     $group_hash_ref = ${$config_ref}{$group};
     if (!exists ${$group_hash_ref}{$option_name}) {
         # no option
-        print "$prefix fatal error: no '$option_name' option in group '$group' in MySQL options file '$config_file\n";
+        print "$prefix fatal error: no '$option_name' option in group '$group' in MySQL options\n";
         exit(1);
     }
 
